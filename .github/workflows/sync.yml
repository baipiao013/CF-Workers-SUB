name: Upstream Sync

on:
  schedule:
    - cron: "0 */2 * * *" # every day
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # Step 1: run a standard checkout action
      - name: Checkout target repo
        uses: actions/checkout@v3

      # Step 2: run the sync action
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: cmliu/CF-Workers-SUB
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # automatically generated, no need to set

          # Set test_mode true to run tests instead of the true action!!
          test_mode: false

      - name: Sync check
        if: failure()
        run: |
          echo "[Error] ç”±äºä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å˜æ›´ï¼Œå¯¼è‡´ GitHub è‡ªåŠ¨æš‚åœäº†æœ¬æ¬¡è‡ªåŠ¨æ›´æ–°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ Sync Fork ä¸€æ¬¡ï¼Œè¯¦ç»†æ•™ç¨‹è¯·æŸ¥çœ‹é¡¹ç›®README.md "
          echo "[Error] Due to a change in the workflow file of the upstream repository, GitHub has automatically suspended the scheduled automatic update. You need to manually sync your fork. Please refer to the project README.md for instructions. "
          exit 1

        # åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
      - name: ğŸ‰ Delete old workflow run
        uses: yxdz2020/delete-workflow-runs@v20250609
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 50
